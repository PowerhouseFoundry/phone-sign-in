<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phone Locker Sign In/Out</title>
  <style>
    :root{
      --bg1:#f5f8ff;
      --bg2:#eef2ff;

      --text:#0f172a;
      --muted:#475569;
      --line:#e2e8f0;

      --accent:#2563eb;
      --accent2:#7c3aed;

      --green:#16a34a;
      --greenBg:#dcfce7;

      --red:#dc2626;
      --redBg:#fee2e2;

      --shadow: 0 16px 46px rgba(15, 23, 42, .14);
      --shadow2: 0 10px 22px rgba(15, 23, 42, .10);

      --radius: 18px;
      --radius2: 14px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 700px at 20% 20%, rgba(37,99,235,.11), transparent 55%),
        radial-gradient(900px 700px at 85% 75%, rgba(124,58,237,.09), transparent 55%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
      overflow:hidden;
    }

    .app{
      width:min(1180px, 100%);
      height: calc(100vh - 20px);
      max-height: 820px;
      border-radius: calc(var(--radius) + 8px);
      box-shadow: var(--shadow);
      overflow:hidden;
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.58);
      backdrop-filter: blur(10px);
      position:relative;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-bottom:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.78);
      gap:12px;
    }
    .brand{display:flex;gap:10px;align-items:center;min-width:0}
    .badge{
      width:34px;height:34px;
      border-radius: 11px;
      background: linear-gradient(145deg, rgba(37,99,235,.18), rgba(124,58,237,.16));
      border:1px solid rgba(15,23,42,.08);
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .brand h1{
      font-size:16px;
      line-height:1.1;
      margin:0;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:2px 0 0;
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .right{
      display:flex;
      gap:8px;
      align-items:center;
      color:var(--muted);
      font-size:11px;
      user-select:none;
      flex:0 0 auto;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 12px rgba(15,23,42,.05);
      white-space:nowrap;
    }

    .content{
      flex:1 1 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      padding:12px;
      align-items:stretch;
      overflow:hidden;
      min-height:0;
    }
    @media (max-width: 980px){
      .content{grid-template-columns:1fr; overflow:auto;}
    }

    .panel{
      border-radius: var(--radius);
      border:1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.80);
      box-shadow: var(--shadow2);
      overflow:hidden;
      min-height:0;
    }

    /* LEFT */
    .left{
      padding:12px;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:10px;
      min-height:0;
    }
    .left h2{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.3}

    .steps{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .step{
      display:inline-flex;gap:7px;align-items:center;
      padding:6px 8px;border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      font-size:11px;color: var(--muted);
    }
    .step b{ color: var(--text); }
    .num{
      width:18px;height:18px;border-radius:999px;
      display:grid;place-items:center;
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.18);
      color: var(--accent);
      font-weight:700;font-size:11px;flex:0 0 auto;
    }

    .phoneWrap{
      border-radius: var(--radius);
      border:1px solid rgba(15,23,42,.08);
      background:
        radial-gradient(420px 240px at 35% 30%, rgba(37,99,235,.08), transparent 60%),
        radial-gradient(420px 240px at 70% 80%, rgba(124,58,237,.06), transparent 60%),
        rgba(255,255,255,.82);
      padding:10px;
      display:grid;
      place-items:center;
      height: 190px;
    }
    .phoneSVG{
      width: 140px;
      height:auto;
      filter: drop-shadow(0 10px 18px rgba(15,23,42,.18));
    }

    .form{
      border-top:1px solid rgba(15,23,42,.08);
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }
    .row2{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    label{display:block;font-size:11px;color:var(--muted);margin:0 0 6px}
    .field{
      padding:12px 12px;
      border-radius: var(--radius2);
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.95);
      color:var(--text);
      outline:none;width:100%;
      font-size:16px;
      letter-spacing: .8px;
      box-shadow: 0 8px 16px rgba(15,23,42,.05);
    }
    .field:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.14), 0 10px 18px rgba(15,23,42,.06);
    }
    select.field{
      letter-spacing:.2px;
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(15,23,42,.75) 50%),
        linear-gradient(135deg, rgba(15,23,42,.75) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 18px,
        calc(100% - 12px) 18px;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right:38px;
    }

    .seg{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    .segBtn{
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      padding:12px;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:54px;
      box-shadow: 0 10px 18px rgba(15,23,42,.05);
      transition: transform .08s ease, border-color .12s ease, background .12s ease;
    }
    .segBtn:active{transform: scale(.99)}
    .segBtn[aria-pressed="true"]{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.08);
    }
    .segLeft strong{ font-size:15px; }
    .segLeft span{ font-size:11px; color: var(--muted); }
    .check{
      width:24px;height:24px;border-radius:999px;
      border:1px solid rgba(15,23,42,.14);
      display:grid;place-items:center;
      background: rgba(255,255,255,.95);
      flex:0 0 auto;
    }
    .segBtn[aria-pressed="true"] .check{
      border-color: rgba(37,99,235,.45);
      background: rgba(37,99,235,.12);
    }
    .check svg{ width:15px;height:15px; opacity:0; transition: opacity .12s ease; }
    .segBtn[aria-pressed="true"] .check svg{ opacity:1; }

    .actions{
      display:flex;gap:10px;flex-wrap:wrap;
      align-items:center;justify-content:space-between;
      border-top:1px solid rgba(15,23,42,.08);
      padding-top:10px;margin-top:2px;
    }
    .btn{
      border:0;cursor:pointer;
      border-radius: 14px;
      padding:12px 14px;
      font-size:14px;
      color:#fff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 12px 22px rgba(37,99,235,.16);
      min-width: 150px;
    }
    .btn:active{transform: scale(.99)}
    .btn.secondary{
      color: var(--text);
      background: rgba(255,255,255,.95);
      border:1px solid rgba(15,23,42,.12);
      box-shadow: 0 10px 18px rgba(15,23,42,.05);
      min-width: 120px;
    }
    .status{
      font-size:11px;color:var(--muted);
      line-height:1.35;max-width: 360px;
    }
    .status strong{color: var(--text)}

    /* RIGHT */
    .board{
      padding:12px;
      display:grid;
      grid-template-rows: auto 1fr auto;
      gap:10px;
      min-height:0;
    }
    .boardHead{
      display:flex;align-items:flex-start;
      justify-content:space-between;gap:10px;
    }
    .boardHead h3{margin:0;font-size:16px;letter-spacing:.2px}
    .legend{
      display:flex;gap:8px;flex-wrap:wrap;
      justify-content:flex-end;align-items:center;
      color:var(--muted);font-size:11px;user-select:none;
    }
    .chip{
      display:inline-flex;gap:7px;align-items:center;
      padding:6px 9px;border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 12px rgba(15,23,42,.04);
      white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:99px;background: var(--green);flex:0 0 auto;}
    .dot.out{background: var(--red);}

    .gridLockers{
      overflow:hidden;min-height:0;
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:8px;
      align-content:start;
    }

    .lockerCard{
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      padding:10px 10px 8px;
      display:flex;flex-direction:column;gap:6px;
      min-height:92px;
      box-shadow: 0 8px 16px rgba(15,23,42,.05);
      cursor:pointer;
      transition: transform .08s ease;
      background: #fff;
    }
    .lockerCard:active{transform:scale(.99)}
    .lockerCard.in{
      background: linear-gradient(180deg, var(--greenBg), rgba(255,255,255,.96));
      border-color: rgba(22,163,74,.22);
    }
    .lockerCard.out{
      background: linear-gradient(180deg, var(--redBg), rgba(255,255,255,.96));
      border-color: rgba(220,38,38,.22);
    }

    .lockerTop{
      display:flex;align-items:center;
      justify-content:space-between;gap:8px;
    }
    .lockerNum{font-weight:900;letter-spacing:.2px;font-size:13px}

    .statusPill{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 8px;border-radius:999px;
      font-size:11px;font-weight:800;line-height:1;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.82);
      white-space:nowrap;
    }

    .meta{display:flex;flex-direction:column;gap:3px}
    .metaLine{font-size:12px}
    .metaLine small{color:var(--muted);font-size:11px}
    .metaSub{font-size:11px;color:var(--muted);line-height:1.2}

    .boardActions{
      display:flex;align-items:center;
      justify-content:space-between;gap:10px;
      border-top:1px solid rgba(15,23,42,.08);
      padding-top:10px;flex-wrap:wrap;
    }
    .tinyBtn{
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.95);
      color: var(--text);
      border-radius: 12px;
      padding:10px 12px;
      cursor:pointer;
      font-size:12px;
      box-shadow: 0 8px 16px rgba(15,23,42,.05);
    }
    .count{font-size:11px;color:var(--muted);white-space:nowrap}

    /* Toast */
    .toast{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      bottom:12px;
      background: rgba(255,255,255,.97);
      border:1px solid rgba(15,23,42,.12);
      border-radius: 14px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      display:none;
      gap:10px;
      align-items:flex-start;
      width: min(720px, calc(100% - 24px));
    }
    .toast.show{display:flex}
    .toast .dotToast{
      width:10px;height:10px;border-radius:99px;
      background: var(--green);
      margin-top:4px;flex:0 0 auto;
    }
    .toast .dotToast.bad{background: var(--red)}
    .toast .msg{font-size:12px;color:var(--text);line-height:1.35}

    input, select, button{ -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <main class="app" role="application" aria-label="Phone locker sign in/out screen">
    <header class="topbar">
      <div class="brand">
        <div class="badge" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M8.5 2.5h7A2.5 2.5 0 0 1 18 5v14a2.5 2.5 0 0 1-2.5 2.5h-7A2.5 2.5 0 0 1 6 19V5A2.5 2.5 0 0 1 8.5 2.5Z" stroke="rgba(15,23,42,.9)" stroke-width="1.6"/>
            <path d="M10 5.5h4" stroke="rgba(15,23,42,.9)" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div style="min-width:0">
          <h1>Phone Locker Sign In / Out</h1>
          <p>Lockers 1–15 • Live availability • Initials only</p>
        </div>
      </div>

      <div class="right" aria-hidden="true">
        <div class="pill" id="datePill">—</div>
        <div class="pill" id="timePill">—</div>
      </div>
    </header>

    <section class="content">
      <!-- LEFT -->
      <section class="panel left" aria-label="Sign in/out panel">
        <div>
          <h2>Sign a phone in or out</h2>
          <p class="sub">Select locker, type initials, choose In/Out, then Record.</p>
          <div class="steps" aria-hidden="true">
            <span class="step"><span class="num">1</span> <b>Locker</b></span>
            <span class="step"><span class="num">2</span> <b>Initials</b></span>
            <span class="step"><span class="num">3</span> <b>In/Out</b></span>
            <span class="step"><span class="num">4</span> <b>Record</b></span>
          </div>
        </div>

        <div class="phoneWrap" aria-hidden="true">
          <svg class="phoneSVG" viewBox="0 0 360 520" fill="none">
            <defs>
              <linearGradient id="g1" x1="40" y1="30" x2="330" y2="500" gradientUnits="userSpaceOnUse">
                <stop stop-color="rgba(37,99,235,.55)"/>
                <stop offset="1" stop-color="rgba(124,58,237,.45)"/>
              </linearGradient>
              <linearGradient id="g2" x1="90" y1="120" x2="280" y2="420" gradientUnits="userSpaceOnUse">
                <stop stop-color="rgba(15,23,42,.10)"/>
                <stop offset="1" stop-color="rgba(15,23,42,.03)"/>
              </linearGradient>
            </defs>

            <circle cx="125" cy="150" r="120" fill="url(#g1)" opacity=".18"/>
            <circle cx="250" cy="360" r="120" fill="url(#g1)" opacity=".12"/>

            <rect x="70" y="35" width="220" height="450" rx="38" fill="rgba(15,23,42,.86)" stroke="rgba(15,23,42,.15)" stroke-width="2"/>
            <rect x="90" y="70" width="180" height="360" rx="22" fill="url(#g2)" stroke="rgba(15,23,42,.10)" stroke-width="1.5"/>
            <rect x="135" y="52" width="90" height="16" rx="8" fill="rgba(255,255,255,.10)"/>
            <circle cx="210" cy="60" r="4" fill="rgba(255,255,255,.20)"/>
            <rect x="150" y="56" width="38" height="8" rx="4" fill="rgba(255,255,255,.16)"/>
            <rect x="112" y="112" width="136" height="16" rx="8" fill="rgba(15,23,42,.12)"/>
            <rect x="112" y="144" width="100" height="12" rx="6" fill="rgba(15,23,42,.10)"/>
            <rect x="112" y="176" width="120" height="12" rx="6" fill="rgba(15,23,42,.10)"/>
            <rect x="112" y="228" width="136" height="70" rx="16" fill="rgba(15,23,42,.08)" stroke="rgba(15,23,42,.10)"/>
            <rect x="126" y="244" width="108" height="12" rx="6" fill="rgba(15,23,42,.10)"/>
            <rect x="126" y="264" width="76" height="12" rx="6" fill="rgba(15,23,42,.10)"/>
            <rect x="112" y="318" width="136" height="70" rx="16" fill="rgba(15,23,42,.08)" stroke="rgba(15,23,42,.10)"/>
            <rect x="126" y="334" width="108" height="12" rx="6" fill="rgba(15,23,42,.10)"/>
            <rect x="126" y="354" width="90" height="12" rx="6" fill="rgba(15,23,42,.10)"/>
            <rect x="150" y="444" width="60" height="6" rx="3" fill="rgba(255,255,255,.18)"/>
          </svg>
        </div>

        <div class="form" aria-label="Form">
          <div class="row2">
            <div>
              <label for="locker">Locker number</label>
              <select id="locker" class="field" aria-label="Locker number">
                <option value="" selected disabled>Select locker…</option>
              </select>
            </div>

            <div>
              <label for="initials">Student initials</label>
              <input
                id="initials"
                class="field"
                type="text"
                inputmode="text"
                autocomplete="off"
                autocapitalize="characters"
                spellcheck="false"
                maxlength="4"
                placeholder="e.g. JM"
                aria-label="Type initials"
              />
            </div>
          </div>

          <div class="seg" role="group" aria-label="Choose In or Out">
            <button id="segIn" class="segBtn" type="button" aria-pressed="false">
              <div class="segLeft">
                <strong>In</strong>
                <span>Available</span>
              </div>
              <div class="check" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M20 7L10 17l-5-5" stroke="rgba(37,99,235,.95)" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </button>

            <button id="segOut" class="segBtn" type="button" aria-pressed="false">
              <div class="segLeft">
                <strong>Out</strong>
                <span>In use</span>
              </div>
              <div class="check" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none">
                  <path d="M20 7L10 17l-5-5" stroke="rgba(37,99,235,.95)" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
            </button>
          </div>

          <div class="actions">
            <button class="btn" id="submitBtn" type="button">Record</button>
            <button class="btn secondary" id="clearBtn" type="button">Clear</button>

            <div class="status" id="status">
              <strong>Ready.</strong> Tap a locker card on the right to select it quickly.
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="panel board" aria-label="Live availability board">
        <div class="boardHead">
          <div>
            <h3>Locker availability</h3>
            <p class="sub" style="margin:6px 0 0">Green = available • Red = in use</p>
          </div>

          <div class="legend" aria-hidden="true">
            <span class="chip"><span class="dot"></span> Available</span>
            <span class="chip"><span class="dot out"></span> In use</span>
          </div>
        </div>

        <div class="gridLockers" id="gridLockers" aria-label="Lockers 1 to 15"></div>

        <div class="boardActions">
          <button class="tinyBtn" id="resetBtn" type="button">Reset all</button>
          <div class="count" id="countLine">—</div>
        </div>
      </section>
    </section>

    <div class="toast" id="toast" role="status" aria-live="polite">
      <div class="dotToast" id="toastDot"></div>
      <div class="msg" id="toastMsg">Saved.</div>
    </div>
  </main>

  <script>
    // --------------------------
    // Data model (stored locally)
    // --------------------------
    const STORAGE_KEY = "phoneLockerRecords_v4";
    const LOCKER_COUNT = 15;

    /**
     * record shape:
     * {
     *   status: "IN"|"OUT",
     *   initials: string,        // current holder when OUT, blank when IN
     *   ts: number,              // last change time
     *   lastOutInitials: string, // remembers who last signed it out
     *   lastOutTs: number        // remembers when it was last signed out
     * }
     */
    const defaultRecords = () => {
      const obj = {};
      for (let i = 1; i <= LOCKER_COUNT; i++){
        obj[i] = { status: "IN", initials: "", ts: Date.now(), lastOutInitials: "", lastOutTs: 0 };
      }
      return obj;
    };

    const loadRecords = () => {
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultRecords();
        const parsed = JSON.parse(raw);

        // upgrade / sanity
        for (let i = 1; i <= LOCKER_COUNT; i++){
          if (!parsed[i]) parsed[i] = { status:"IN", initials:"", ts:Date.now(), lastOutInitials:"", lastOutTs:0 };
          parsed[i].status = (parsed[i].status === "OUT") ? "OUT" : "IN"; // remove "not set"
          parsed[i].initials = parsed[i].initials || "";
          parsed[i].ts = parsed[i].ts || Date.now();
          parsed[i].lastOutInitials = parsed[i].lastOutInitials || "";
          parsed[i].lastOutTs = parsed[i].lastOutTs || 0;
        }
        return parsed;
      }catch(e){
        return defaultRecords();
      }
    };

    const saveRecords = (records) => {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    };

    let records = loadRecords();

    // --------------------------
    // UI refs
    // --------------------------
    const lockerSelect = document.getElementById('locker');
    for (let i = 1; i <= LOCKER_COUNT; i++){
      const opt = document.createElement('option');
      opt.value = String(i);
      opt.textContent = 'Locker ' + i;
      lockerSelect.appendChild(opt);
    }

    const initialsEl = document.getElementById('initials');
    const segIn = document.getElementById('segIn');
    const segOut = document.getElementById('segOut');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resetBtn = document.getElementById('resetBtn');
    const statusEl = document.getElementById('status');

    const gridLockers = document.getElementById('gridLockers');
    const countLine = document.getElementById('countLine');

    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    const toastDot = document.getElementById('toastDot');

    // --------------------------
    // Helpers
    // --------------------------
    const setChoice = (chosen) => {
      segIn.setAttribute('aria-pressed', chosen === 'IN' ? 'true' : 'false');
      segOut.setAttribute('aria-pressed', chosen === 'OUT' ? 'true' : 'false');
    };

    const getChoice = () => {
      if (segIn.getAttribute('aria-pressed') === 'true') return 'IN';
      if (segOut.getAttribute('aria-pressed') === 'true') return 'OUT';
      return '';
    };

    const showToast = (message, ok=true) => {
      toastMsg.textContent = message;
      toastDot.classList.toggle('bad', !ok);
      toast.classList.add('show');
      window.clearTimeout(showToast._t);
      showToast._t = window.setTimeout(() => toast.classList.remove('show'), 2000);
    };

    const fmtTime = (ts) => {
      if (!ts) return "—";
      const d = new Date(ts);
      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    };

    const fmtDate = (ts) => {
      if (!ts) return "—";
      const d = new Date(ts);
      return d.toLocaleDateString([], {day:"2-digit", month:"short"});
    };

    const escapeHtml = (str) => {
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    };

    // --------------------------
    // Render board
    // --------------------------
    const renderBoard = () => {
      gridLockers.innerHTML = "";

      let inCount = 0, outCount = 0;

      for (let i = 1; i <= LOCKER_COUNT; i++){
        const r = records[i];
        const status = r.status;

        if (status === "IN") inCount++;
        else outCount++;

        const card = document.createElement("div");
        card.className = "lockerCard " + (status === "IN" ? "in" : "out");

        const pillText = status === "IN" ? "Available" : "In use";
        const dotClass = status === "IN" ? "" : "out";

        // "In use" shows current holder
        const holder = (status === "OUT" && r.initials) ? r.initials : "—";

        // "Available" shows last signed out by/time (if any)
        const lastOutWho = r.lastOutInitials ? r.lastOutInitials : "—";
        const lastOutWhen = r.lastOutTs ? (fmtDate(r.lastOutTs) + " • " + fmtTime(r.lastOutTs)) : "—";

        const infoLines = (status === "OUT")
          ? `
              <div class="metaLine"><small>Signed out by:</small> <strong>${escapeHtml(holder)}</strong></div>
              <div class="metaSub"><small>Updated:</small> ${escapeHtml(fmtDate(r.ts) + " • " + fmtTime(r.ts))}</div>
            `
          : `
              <div class="metaLine"><small>Last signed out by:</small> <strong>${escapeHtml(lastOutWho)}</strong></div>
              <div class="metaSub"><small>Time:</small> ${escapeHtml(lastOutWhen)}</div>
            `;

        card.innerHTML = `
          <div class="lockerTop">
            <div class="lockerNum">Locker ${i}</div>
            <div class="statusPill">
              <span class="dot ${dotClass}"></span>
              ${pillText}
            </div>
          </div>
          <div class="meta">
            ${infoLines}
          </div>
        `;

        // Clicking a locker: preselect and make it easy to do the "right" action
        card.addEventListener("click", () => {
          lockerSelect.value = String(i);
          initialsEl.focus();

          if (records[i].status === "OUT"){
            // Most common: returning it
            setChoice("IN");
            statusEl.innerHTML = `<strong>Locker ${i}</strong> selected. Choose <strong>In</strong> and record to return the phone.`;
          } else {
            // Taking it out
            setChoice("OUT");
            statusEl.innerHTML = `<strong>Locker ${i}</strong> selected. Choose <strong>Out</strong> and record to take the phone.`;
          }
        });

        gridLockers.appendChild(card);
      }

      countLine.textContent = `Available: ${inCount} • In use: ${outCount}`;
    };

    // --------------------------
    // Input behaviour
    // --------------------------
    initialsEl.addEventListener('input', () => {
      initialsEl.value = initialsEl.value.toUpperCase().replace(/[^A-Z]/g,'');
    });

    segIn.addEventListener('click', () => setChoice('IN'));
    segOut.addEventListener('click', () => setChoice('OUT'));

    const clearForm = () => {
      lockerSelect.value = '';
      initialsEl.value = '';
      setChoice('');
      statusEl.innerHTML = '<strong>Ready.</strong> Tap a locker card on the right to select it quickly.';
      initialsEl.focus();
    };
    clearBtn.addEventListener('click', clearForm);

    submitBtn.addEventListener('click', () => {
      const locker = lockerSelect.value;
      const initials = initialsEl.value.trim();
      const choice = getChoice();

      if (!locker){
        showToast('Select a locker number.', false);
        lockerSelect.focus();
        return;
      }
      if (!initials){
        showToast('Type initials.', false);
        initialsEl.focus();
        return;
      }
      if (!choice){
        showToast('Choose In or Out.', false);
        segIn.focus();
        return;
      }

      const now = Date.now();
      const current = records[locker];

      if (choice === "OUT"){
        // phone taken out => unavailable
        records[locker] = {
          ...current,
          status: "OUT",
          initials: initials,
          ts: now,
          lastOutInitials: initials,
          lastOutTs: now
        };
      } else {
        // phone returned => available
        // Keep lastOut* as history, but clear current holder initials
        records[locker] = {
          ...current,
          status: "IN",
          initials: "",
          ts: now
        };
      }

      saveRecords(records);
      renderBoard();

      showToast(`Saved: ${initials} • Locker ${locker} • ${choice === 'IN' ? 'In (Available)' : 'Out (In use)'}`, true);

      // reset form after record
      window.clearTimeout(submitBtn._t);
      submitBtn._t = window.setTimeout(() => {
        lockerSelect.value = '';
        initialsEl.value = '';
        setChoice('');
        initialsEl.focus();
      }, 850);
    });

    // Reset board (double tap)
    resetBtn.addEventListener("click", () => {
      if (!resetBtn.dataset.armed){
        resetBtn.dataset.armed = "1";
        resetBtn.textContent = "Tap again to confirm";
        showToast("Reset armed. Tap again.", false);
        window.clearTimeout(resetBtn._t);
        resetBtn._t = window.setTimeout(() => {
          delete resetBtn.dataset.armed;
          resetBtn.textContent = "Reset all";
        }, 2000);
        return;
      }

      delete resetBtn.dataset.armed;
      resetBtn.textContent = "Reset all";
      records = defaultRecords();
      saveRecords(records);
      renderBoard();
      showToast("All lockers reset.", true);
      clearForm();
    });

    // Top-right clock
    const datePill = document.getElementById('datePill');
    const timePill = document.getElementById('timePill');
    const tickClock = () => {
      const now = new Date();
      timePill.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      datePill.textContent = now.toLocaleDateString([], {month:'short', day:'numeric', year:'numeric'});
    };
    tickClock();
    setInterval(tickClock, 1000 * 15);

    renderBoard();
    window.addEventListener('load', () => {
      try { initialsEl.focus(); } catch(e){}
    });
  </script>
</body>
</html>
